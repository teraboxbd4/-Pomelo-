<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Click2Cash üçã </title>
    <!-- Firebase SDK, Telegram Script, Tailwind CSS, Font Awesome, Google Fonts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans Bengali', sans-serif; }
        html { height: 100%; }
        body { background: linear-gradient(135deg, #87CEEB, #98FB98); color: #1F2937; height: 100%; overflow: hidden; }
        .app-wrapper { height: 100vh; display: flex; flex-direction: column; }
        main { flex-grow: 1; overflow-y: auto; padding: 0.75rem; }
        .glass-card { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #00CED1, #20B2AA); color: white; border-radius: 16px; padding: 14px 24px; font-weight: bold; transition: all 0.3s ease; border: none; cursor: pointer; }
        .btn-primary:disabled { background: #999; opacity: 0.7; cursor: not-allowed; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.3); display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 12px; color: #64748b; transition: all 0.3s ease; padding: 8px 12px; border-radius: 16px; cursor: pointer; }
        .nav-item.active { color: #00CED1; background: rgba(0, 206, 209, 0.1); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #87CEEB, #98FB98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .loader-spinner { border: 5px solid rgba(255, 255, 255, 0.3); border-top: 5px solid #ffffff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .loader-text { margin-top: 20px; color: #fff; font-size: 1.2rem; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #spin .glass-card { display: flex; flex-direction: column; align-items: center; }
        .wheel-container { position: relative; width: 280px; height: 280px; margin: 15px auto; }
        .wheel-pointer { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 35px; height: 45px; background: linear-gradient(160deg, #ff7675, #d63031); clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 20; filter: drop-shadow(0px 4px 5px rgba(0, 0, 0, 0.3)); }
        .wheel { width: 100%; height: 100%; border-radius: 50%; position: relative; overflow: hidden; background: #bdc3c7; transition: transform 6s cubic-bezier(0.1, 0.7, 0.0, 1); }
        .wheel-section { position: absolute; width: 50%; height: 50%; transform-origin: bottom right; clip-path: polygon(0 0, 100% 0, 100% 100%); display: flex; align-items: center; justify-content: center; }
        .wheel-section span { display: block; color: white; font-weight: 700; font-size: 16px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); transform: rotate(22.5deg) translateY(-100%);}
        input, select { background: rgba(255, 255, 255, 0.7) !important; border-radius: 12px !important; border: 1px solid rgba(255, 255, 255, 0.3) !important; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 24px; width: 90%; max-width: 400px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .profile-pic-container { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
        .profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .support-fab { position: fixed; bottom: 85px; right: 20px; width: 50px; height: 50px; background-color: #00CED1; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 999; }
        .task-card { display: flex; align-items: center; justify-content: space-between; padding: 12px; }
        .task-card-icon { font-size: 28px; color: #00CED1; margin-right: 12px; }
        .task-card-details { flex-grow: 1; }
    </style>
</head>
<body>
    <div id="loader">
        <div class="loader-spinner"></div>
        <p class="loader-text">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <div id="main-app" class="hidden app-wrapper">
        <header class="p-4 flex justify-between items-center glass-card m-2 rounded-2xl flex-shrink-0">
            <div><h1 class="text-2xl font-bold">‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶Æ‡¶∞‡¶ø‡¶ö</h1><p class="text-gray-600">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡¶•</p></div>
            <div class="text-right"><p id="header-user-name" class="font-semibold"></p><p class="text-sm">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥<span id="header-balance">0.00</span></p></div>
        </header>
        <main>
            <div class="pb-24"> 
                <section id="home" class="content-section active">
                    <div class="glass-card p-6 mb-6 text-center"><h2 class="text-lg">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</h2><p class="text-5xl font-bold">‡ß≥<span id="wallet-balance">0.00</span></p><div class="mt-4 flex justify-around text-sm"><div><p>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶Ø‡¶º</p><p class="font-bold">‡ß≥<span id="today-earnings">0.00</span></p></div><div><p>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</p><p class="font-bold"><span id="referral-count">0</span> ‡¶ú‡¶®</p></div></div><button id="withdraw-btn-home" class="btn-primary mt-6 w-full"><i class="fas fa-money-bill-wave mr-2"></i> ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</button></div>
                    <div class="grid grid-cols-2 gap-4 mb-6"><button id="watch-ad-btn" class="glass-card p-4 flex flex-col items-center justify-center"><i class="fas fa-video text-3xl mb-2 text-cyan-500"></i><span class="font-semibold">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</span><span id="watch-ad-notice" class="text-xs mt-1"></span></button><button data-target="tasks" class="nav-btn glass-card p-4 flex flex-col items-center justify-center"><i class="fas fa-tasks text-3xl mb-2 text-cyan-500"></i><span class="font-semibold">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</span><span id="do-task-notice" class="text-xs mt-1"></span></button><button data-target="spin" class="nav-btn glass-card p-4 flex flex-col items-center justify-center"><i class="fas fa-dharmachakra text-3xl mb-2 text-cyan-500"></i><span class="font-semibold">‡¶∏‡ßç‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span><span id="spin-wheel-notice" class="text-xs mt-1"></span></button><button data-target="profile" class="nav-btn glass-card p-4 flex flex-col items-center justify-center"><i class="fas fa-user-plus text-3xl mb-2 text-cyan-500"></i><span class="font-semibold">‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</span><span id="referral-notice" class="text-xs mt-1"></span></button></div>
                    <div class="glass-card p-6"><h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-history mr-3 text-cyan-500"></i>‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</h3><div id="recent-activity" class="space-y-3"></div></div>
                </section>
                <section id="tasks" class="content-section"><div class="glass-card p-4"><h2 class="text-2xl font-bold mb-4 text-center"><i class="fas fa-tasks mr-3 text-cyan-500"></i>‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</h2><div id="tasks-list" class="space-y-3"></div></div></section>
                <section id="spin" class="content-section"><div class="glass-card p-6 text-center"><h2 class="text-2xl font-bold mb-2">‡¶∏‡ßç‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®</h2><p class="mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßç‡¶™‡¶ø‡¶®: <span id="spins-left">3</span>/<span id="daily-spin-limit-text">3</span></p><div class="wheel-container"><div class="wheel" id="wheel"></div><div class="wheel-pointer"></div></div><button id="spin-wheel-btn" class="btn-primary w-full py-3 text-lg mt-4">‡¶∏‡ßç‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></section>
                <section id="wallet" class="content-section">
                    <div class="glass-card p-6"><div class="mb-6"><h3 class="text-xl font-bold mb-4">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ</h3><div id="withdrawal-conditions" class="space-y-2 p-4 bg-white/50 rounded-lg"></div></div><h2 class="text-2xl font-bold mb-4"><i class="fas fa-wallet mr-3 text-cyan-500"></i>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü</h2><div class="mb-4 p-4 bg-cyan-100 rounded-xl text-gray-800"><p>‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p><p class="text-4xl font-bold my-2">‡ß≥<span id="wallet-total">0.00</span></p><p class="text-sm">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®: ‡ß≥<span id="min-withdrawal-text">50.00</span></p></div><div id="wallet-notice" class="mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg hidden"></div><button id="wallet-withdraw-btn" class="btn-primary w-full py-3 mb-8"><i class="fas fa-money-bill-wave mr-2"></i> ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button><div><h3 class="text-xl font-bold mb-4">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</h3><div id="withdrawal-history" class="space-y-3"></div></div></div>
                </section>
                <section id="profile" class="content-section">
                    <div class="glass-card p-4">
                        <div class="flex items-center space-x-4">
                            <div class="profile-pic-container"><img id="profile-pic-img" src="https://i.ibb.co/6y4n3SM/default-avatar.png" alt="Profile Picture" class="profile-pic"></div>
                            <div class="flex-grow">
                                <div id="name-display-container" class="flex items-center"><h2 id="profile-name-text" class="text-xl font-bold text-gray-800"></h2><i id="edit-name-btn" class="fas fa-pencil-alt ml-3 text-sm text-gray-600 cursor-pointer hover:text-cyan-600"></i></div>
                                <div id="name-edit-container" class="hidden"><input type="text" id="profile-name-input" class="w-full text-xl font-bold p-1 border rounded-md"><button id="save-name-btn" class="btn-primary py-1 px-3 mt-1 text-sm">‡¶∏‡ßá‡¶≠</button></div>
                                <p id="profile-join-date" class="text-xs text-gray-600 mt-1"></p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-6 mt-6">
                         <div class="p-4 bg-white/70 rounded-lg mb-6"><p class="mb-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï</p><div class="flex"><input type="text" id="referral-link" class="flex-grow p-2 bg-gray-100 rounded-l-lg" readonly><button id="copy-link" class="bg-cyan-500 text-white px-4 rounded-r-lg"><i class="fas fa-copy"></i></button></div></div>
                        <div class="grid grid-cols-2 gap-4 mb-6"><div class="p-3 bg-white/70 rounded-lg text-center"><p class="text-2xl font-bold text-cyan-500" id="profile-tasks">0</p><p>‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</p></div><div class="p-3 bg-white/70 rounded-lg text-center"><p class="text-2xl font-bold text-green-500" id="profile-referrals">0</p><p>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</p></div></div>
                    </div>
                </section>
            </div>
        </main>
        <nav class="bottom-nav flex-shrink-0"><a class="nav-item active" data-section="home"><i class="fas fa-home"></i><span>‡¶π‡ßã‡¶Æ</span></a><a class="nav-item" data-section="tasks"><i class="fas fa-tasks"></i><span>‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</span></a><a class="nav-item" data-section="spin"><i class="fas fa-dharmachakra"></i><span>‡¶∏‡ßç‡¶™‡¶ø‡¶®</span></a><a class="nav-item" data-section="wallet"><i class="fas fa-wallet"></i><span>‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü</span></a><a class="nav-item" data-section="profile"><i class="fas fa-user"></i><span>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</span></a></nav>
    </div>
        
    <div id="support-fab" class="support-fab"><i class="fas fa-headset"></i></div>
    <div id="withdraw-modal" class="modal"><div class="modal-content"><h2 class="text-xl font-bold mb-4 text-center">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</h2><form id="withdraw-form"><div class="mb-4"><label class="block mb-2">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</label><select id="withdraw-method" class="w-full p-3"><option>bKash</option><option>Nagad</option><option>Rocket</option></select></div><div class="mb-4"><label class="block mb-2">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="text" id="withdraw-number" class="w-full p-3" required></div><div class="mb-4"><label class="block mb-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label><input type="number" step="0.01" id="withdraw-amount" class="w-full p-3" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" required></div><div class="flex justify-end gap-4 mt-6"><button type="button" class="bg-gray-500 text-white px-4 py-2 rounded-lg" onclick="closeModal('withdraw-modal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button><button type="submit" class="btn-primary px-4 py-2">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button></div></form></div></div>
    <div id="support-modal" class="modal"><div class="modal-content"><h2 class="text-xl font-bold mb-6 text-center">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2><div id="support-links-container"></div><button class="w-full mt-4 py-2 bg-gray-600 text-white rounded-lg" onclick="closeModal('support-modal')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></div>
    <div id="welcome-modal" class="modal"><div class="modal-content"><div class="flex justify-between items-center"><h2 class="text-xl font-bold">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! üî•</h2><span class="text-2xl cursor-pointer" onclick="closeModal('welcome-modal')">&times;</span></div><div id="welcome-modal-body" class="my-4"></div><button class="w-full btn-primary py-2" onclick="closeModal('welcome-modal')">‡¶¨‡ßÅ‡¶ù‡ßá‡¶õ‡¶ø</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBowdaBVkAZa7OLr0wmJxjn9JqSlsy7l5o", authDomain: "pomelo-50690.firebaseapp.com", projectId: "pomelo-50690", storageBucket: "pomelo-50690.firebasestorage.app", messagingSenderId: "687340787607", appId: "1:687340787607:web:5c2fe2d6d0ff09c6c956d2" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let currentUserId = null, userData = null, userListener = null, appSettings = {};
        let adSettings = [], spinAdSettings = [], taskAdSettings = [];
        let presenceInterval = null;
        
        const loader = document.getElementById('loader');
        const mainApp = document.getElementById('main-app');

        // --- CORE APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            window.Telegram.WebApp.ready();
            loadAppSettings().then(initializeTelegramUser);
            initializeEventListeners();
        });

        async function loadAppSettings() {
            const doc = await db.collection('app_settings').doc('config').get();
            const defaults = { minWithdrawal: 50, joiningBonus: 10, referralBonus: 5, dailySpins: 3, watchAdReward: 5, dailyAdLimit: 10, hourlyAdLimit: 2, spinPrizes: [3, 2, 5, 8, 10, 15, 20, 1], minReferrals: 10, supportLinks: [], botUsername: '', welcomeNotice: '' };
            appSettings = doc.exists ? { ...defaults, ...doc.data() } : defaults;
        }

        async function initializeTelegramUser() {
            try {
                if (!window.Telegram?.WebApp?.initDataUnsafe?.user) {
                    document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-center text-red-500 font-bold">‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</div>';
                    return;
                }

                const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                currentUserId = tgUser.id.toString();

                const userRef = db.collection('users').doc(currentUserId);
                const userDoc = await userRef.get();

                if (userDoc.exists) {
                    userData = userDoc.data();
                    let updates = {};
                    const fullName = `${tgUser.first_name} ${tgUser.last_name || ''}`.trim();
                    if (userData.name !== fullName) updates.name = fullName;
                    if (userData.photo_url !== tgUser.photo_url) updates.photo_url = tgUser.photo_url || null;
                    if (Object.keys(updates).length > 0) await userRef.update(updates);
                } else {
                    const initData = new URLSearchParams(window.Telegram.WebApp.initData);
                    const refId = initData.get('start')?.split(' ')[1] || null;
                    const joiningBonus = refId ? (appSettings.joiningBonus || 0) : 0;
                    
                    const newUserData = {
                        telegramId: currentUserId, name: `${tgUser.first_name} ${tgUser.last_name || ''}`.trim(),
                        username: tgUser.username || null, photo_url: tgUser.photo_url || null,
                        balance: joiningBonus, todayEarnings: 0, totalEarnings: joiningBonus, referralEarnings: 0,
                        lastAdWatchDate: '', dailyAdCount: 0, lastAdWatchHour: '', hourlyAdCount: 0,
                        tasksCompleted: [], spinsUsed: 0, lastSpinDate: null, referrals: 0,
                        joinDate: new Date().toISOString(), referredBy: refId, isBanned: false, lastSeen: new Date()
                    };
                    await userRef.set(newUserData);
                    userData = newUserData;

                    if (refId && appSettings.referralBonus > 0) {
                        const referrerRef = db.collection('users').doc(refId);
                        const referralBonus = appSettings.referralBonus;
                        db.runTransaction(async (t) => {
                            const doc = await t.get(referrerRef);
                            if(doc.exists) {
                                t.update(referrerRef, {
                                    balance: firebase.firestore.FieldValue.increment(referralBonus),
                                    referralEarnings: firebase.firestore.FieldValue.increment(referralBonus),
                                    referrals: firebase.firestore.FieldValue.increment(1)
                                });
                            }
                        });
                        await addActivity('‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏', referralBonus, refId);
                    }
                    if (joiningBonus > 0) await addActivity('‡¶ú‡ßü‡ßá‡¶®‡¶ø‡¶Ç ‡¶¨‡ßã‡¶®‡¶æ‡¶∏', joiningBonus, currentUserId);
                }
                
                if (userData.isBanned) {
                    document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-center text-red-500 font-bold">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§</div>';
                    return;
                }

                startApp();
            } catch (error) {
                console.error("Initialization Error:", error);
                document.body.innerHTML = `<div class="flex items-center justify-center h-screen text-center text-red-500 font-bold">‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${error.message}</div>`;
            }
        }
        
        async function startApp() {
            listenToUserData(currentUserId);
            updateLastSeen();
            presenceInterval = setInterval(updateLastSeen, 60 * 1000);
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') updateLastSeen(); });
            
            const [watchAdResult, spinAdResult, taskAdResult] = await Promise.all([
                loadAdScriptsAndSettings('ad_networks'),
                loadAdScriptsAndSettings('spin_ads'),
                loadAdScriptsAndSettings('task_ads')
            ]);
            adSettings = watchAdResult.ads; 
            spinAdSettings = spinAdResult.ads; 
            taskAdSettings = taskAdResult.ads;
            
            mainApp.classList.remove('hidden');
            loader.style.display = 'none';

            if (!localStorage.getItem('welcomeShown-' + currentUserId)) {
                if (appSettings.welcomeNotice) {
                    document.getElementById('welcome-modal-body').innerHTML = appSettings.welcomeNotice;
                    document.getElementById('welcome-modal').style.display = 'flex';
                }
                localStorage.setItem('welcomeShown-' + currentUserId, 'true');
            }
        }

        // --- REAL-TIME DATA LISTENER ---
        function listenToUserData(uid) {
            if (userListener) userListener();
            userListener = db.collection('users').doc(uid).onSnapshot((doc) => {
                if (doc.exists) {
                    userData = doc.data();
                    updateAllUI();
                }
            });
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateAllUI() {
            if (!userData || !appSettings) return;
            ['wallet-balance', 'header-balance', 'wallet-total'].forEach(id => document.getElementById(id).textContent = (userData.balance || 0).toFixed(2));
            ['today-earnings', 'wallet-today'].forEach(id => document.getElementById(id).textContent = (userData.todayEarnings || 0).toFixed(2));
            document.getElementById('referral-count').textContent = userData.referrals || 0;
            document.getElementById('header-user-name').textContent = userData.name;
            document.getElementById('profile-pic-img').src = userData.photo_url || 'https://i.ibb.co/6y4n3SM/default-avatar.png';
            document.getElementById('profile-name-text').textContent = userData.name || 'N/A';
            if(userData.joinDate) { document.getElementById('profile-join-date').textContent = `‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®: ${new Date(userData.joinDate).toLocaleDateString('bn-BD')}`; }
            
            document.getElementById('referral-link').value = `https://t.me/${appSettings.botUsername}?start=ref${currentUserId}`;
            
            document.getElementById('profile-tasks').textContent = (userData.tasksCompleted || []).filter(key => key.endsWith(new Date().toDateString())).length;
            document.getElementById('profile-referrals').textContent = userData.referrals || 0;
            document.getElementById('min-withdrawal-text').textContent = (appSettings.minWithdrawal || 50).toFixed(2);
            document.getElementById('daily-spin-limit-text').textContent = appSettings.dailySpins || 3;
            
            const walletNoticeEl = document.getElementById('wallet-notice');
            if (appSettings.walletNotice) {
                walletNoticeEl.textContent = appSettings.walletNotice;
                walletNoticeEl.classList.remove('hidden');
            } else {
                walletNoticeEl.classList.add('hidden');
            }
            
            const conditionsContainer = document.getElementById('withdrawal-conditions');
            const referralsMet = (userData.referrals || 0) >= (appSettings.minReferrals || 0);
            conditionsContainer.innerHTML = `<p class="flex justify-between"><span>‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤:</span><span class="${referralsMet ? 'text-green-600' : 'text-red-500'} font-bold">${userData.referrals || 0} / ${appSettings.minReferrals || 0} ${referralsMet ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>'}</span></p>`;
            
            const today = new Date().toDateString();
            if (userData.lastSpinDate !== today) {
                db.collection('users').doc(currentUserId).update({ spinsUsed: 0, lastSpinDate: today });
            }
            document.getElementById('spins-left').textContent = (appSettings.dailySpins || 3) - (userData.spinsUsed || 0);
            document.getElementById('spin-wheel-btn').disabled = (userData.spinsUsed || 0) >= (appSettings.dailySpins || 3);

            generateWheelSections();
            populateSupportModal();
            updateTasksList();
            updateRecentActivities();
            loadWithdrawalHistory();
        }

        async function updateTasksList() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '<p class="text-center">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
            const snapshot = await db.collection('tasks').where('status', '==', 'active').orderBy('createdAt', 'desc').get();
            if (snapshot.empty) { list.innerHTML = '<p class="text-center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶®‡ßá‡¶á‡•§</p>'; return; }
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const task = doc.data();
                const taskKey = `${doc.id}_${new Date().toDateString()}`;
                const isCompleted = (userData.tasksCompleted || []).includes(taskKey);
                const buttonHTML = isCompleted ? `<button class="btn-primary" disabled>‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</button>` : `<a href="${task.link}" target="_blank" onclick="claimTaskReward('${doc.id}', ${task.reward})" class="btn-primary py-2 px-4">‡¶ï‡¶∞‡ßÅ‡¶®</a>`;
                list.innerHTML += `<div class="task-card glass-card"><div class="flex items-center"><i class="${task.icon || 'fas fa-download'} task-card-icon"></i><div class="task-card-details"><p class="font-semibold">${task.name}</p><p class="text-sm text-yellow-800 font-bold">‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞: ‡ß≥${task.reward.toFixed(2)}</p></div></div>${buttonHTML}</div>`;
            });
        }
        
        async function claimTaskReward(taskId, reward) {
            const taskKey = `${taskId}_${new Date().toDateString()}`;
            if ((userData.tasksCompleted || []).includes(taskKey)) return;
            try {
                await showMandatoryAdAfterAction(taskAdSettings);
                const inc = firebase.firestore.FieldValue.increment;
                await db.collection('users').doc(currentUserId).update({
                    balance: inc(reward), todayEarnings: inc(reward), totalEarnings: inc(reward),
                    tasksCompleted: firebase.firestore.FieldValue.arrayUnion(taskKey)
                });
                await addActivity('‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞', reward, currentUserId);
            } catch (error) { alert('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§'); }
        }

        async function updateRecentActivities() {
            const container = document.getElementById('recent-activity');
            container.innerHTML = '<p class="text-center">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
            const snapshot = await db.collection('activities').where('userId', '==', currentUserId).orderBy('timestamp', 'desc').limit(5).get();
            if (snapshot.empty) { container.innerHTML = '<p class="text-center">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶®‡ßá‡¶á‡•§</p>'; return; }
            container.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const act = doc.data();
                container.innerHTML += `<div class="flex justify-between items-center p-3 bg-white/70 rounded-lg"><div><p class="font-semibold">${act.title}</p><p class="text-sm">${new Date(act.timestamp).toLocaleString('bn-BD')}</p></div><p class="text-green-500 font-bold">+‡ß≥${act.amount.toFixed(2)}</p></div>`;
            });
        }
        
        async function loadWithdrawalHistory() {
            const historyContainer = document.getElementById('withdrawal-history');
            historyContainer.innerHTML = '<p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
            const snapshot = await db.collection('withdrawals').where('telegramId', '==', currentUserId).orderBy('timestamp', 'desc').limit(10).get();
            if (snapshot.empty) { historyContainer.innerHTML = '<p class="text-center">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§</p>'; return; }
            historyContainer.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const w = doc.data();
                let statusClass = 'text-yellow-600 bg-yellow-100'; // pending
                if (w.status === 'approved') statusClass = 'text-green-600 bg-green-100';
                if (w.status === 'rejected') statusClass = 'text-red-600 bg-red-100';
                historyContainer.innerHTML += `<div class="p-3 bg-white/70 rounded-lg flex justify-between items-center"><div><p class="font-bold">‡ß≥${w.amount.toFixed(2)} - ${w.method}</p><p class="text-sm text-gray-600">${new Date(w.timestamp).toLocaleDateString('bn-BD')}</p></div><span class="px-3 py-1 text-sm font-semibold rounded-full ${statusClass}">${w.status}</span></div>`;
            });
        }

        // --- EVENT LISTENERS ---
        function initializeEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item, .nav-btn').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSection = this.dataset.target || this.dataset.section;
                    document.querySelector('.content-section.active').classList.remove('active');
                    document.getElementById(targetSection).classList.add('active');
                    document.querySelector('.nav-item.active').classList.remove('active');
                    document.querySelector(`.nav-item[data-section="${targetSection}"]`).classList.add('active');
                });
            });

            // Actions
            document.getElementById('watch-ad-btn').addEventListener('click', handleWatchAd);
            document.getElementById('spin-wheel-btn').addEventListener('click', handleSpin);
            document.getElementById('withdraw-form').addEventListener('submit', handleWithdraw);
            
            // Profile Edit
            document.getElementById('edit-name-btn').addEventListener('click', () => {
                document.getElementById('name-display-container').classList.add('hidden');
                document.getElementById('name-edit-container').classList.remove('hidden');
                document.getElementById('profile-name-input').value = userData.name;
            });
            document.getElementById('save-name-btn').addEventListener('click', async () => {
                const newName = document.getElementById('profile-name-input').value.trim();
                if (newName) {
                    await db.collection('users').doc(currentUserId).update({ name: newName });
                    document.getElementById('name-edit-container').classList.add('hidden');
                    document.getElementById('name-display-container').classList.remove('hidden');
                }
            });

            // Utility
            document.getElementById('copy-link').addEventListener('click', () => navigator.clipboard.writeText(document.getElementById('referral-link').value).then(() => alert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!')));
            document.getElementById('support-fab').addEventListener('click', () => document.getElementById('support-modal').style.display = 'flex');
            document.querySelectorAll('#withdraw-btn-home, #wallet-withdraw-btn').forEach(btn => btn.addEventListener('click', () => document.getElementById('withdraw-modal').style.display = 'flex'));
        }

        // --- ACTION HANDLERS ---
        async function handleWatchAd() {
            const btn = this;
            btn.disabled = true;
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const hourStr = `${todayStr}-${now.getHours()}`;
            let { dailyAdCount = 0, lastAdWatchDate = '', hourlyAdCount = 0, lastAdWatchHour = '' } = userData;
            if (lastAdWatchDate !== todayStr) dailyAdCount = 0;
            if (lastAdWatchHour !== hourStr) hourlyAdCount = 0;
            if (dailyAdCount >= appSettings.dailyAdLimit) { alert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§'); btn.disabled = false; return; }
            if (hourlyAdCount >= appSettings.hourlyAdLimit) { alert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§'); btn.disabled = false; return; }
            try {
                await showMandatoryAdAfterAction(adSettings);
                const rewardAmount = appSettings.watchAdReward;
                if (rewardAmount > 0) {
                    const inc = firebase.firestore.FieldValue.increment;
                    await db.collection('users').doc(currentUserId).update({
                        balance: inc(rewardAmount), todayEarnings: inc(rewardAmount), totalEarnings: inc(rewardAmount),
                        dailyAdCount: inc(1), lastAdWatchDate: todayStr, hourlyAdCount: inc(1), lastAdWatchHour: hourStr
                    });
                    await addActivity('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ', rewardAmount, currentUserId);
                }
            } catch (e) { alert('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§'); } finally { btn.disabled = false; }
        }

        let isSpinning = false;
        async function handleSpin() {
            if (isSpinning || (userData.spinsUsed || 0) >= appSettings.dailySpins) return;
            isSpinning = true;
            this.disabled = true;
            const wheel = document.getElementById('wheel');
            const prizeIndex = Math.floor(Math.random() * appSettings.spinPrizes.length);
            const prizeAmount = appSettings.spinPrizes[prizeIndex];
            const sectionAngle = 360 / appSettings.spinPrizes.length;
            const targetAngle = (Math.floor(Math.random() * 5) + 5) * 360 + (360 - (prizeIndex * sectionAngle) - (sectionAngle / 2));
            wheel.style.transform = `rotate(${targetAngle}deg)`;
            setTimeout(async () => {
                try {
                    await showMandatoryAdAfterAction(spinAdSettings);
                    const inc = firebase.firestore.FieldValue.increment;
                    await db.collection('users').doc(currentUserId).update({
                        balance: inc(prizeAmount), todayEarnings: inc(prizeAmount), totalEarnings: inc(prizeAmount), spinsUsed: inc(1)
                    });
                    await addActivity('‡¶∏‡ßç‡¶™‡¶ø‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶Ø‡¶º', prizeAmount, currentUserId);
                    alert(`‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡ß≥${prizeAmount.toFixed(2)} ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
                } catch (error) { alert('‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§'); }
                finally { isSpinning = false; }
            }, 6000);
        }

        async function handleWithdraw(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            if ((userData.referrals || 0) < appSettings.minReferrals) return alert(`‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ${appSettings.minReferrals}‡¶ü‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§`);
            if (amount < appSettings.minWithdrawal) return alert(`‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ß≥${appSettings.minWithdrawal} ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§`);
            if (amount > userData.balance) return alert('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á‡•§');
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            try {
                await db.collection('withdrawals').add({
                    telegramId: currentUserId, userName: userData.name,
                    amount, method: document.getElementById('withdraw-method').value,
                    number: document.getElementById('withdraw-number').value,
                    status: 'pending', timestamp: new Date().toISOString()
                });
                await db.collection('users').doc(currentUserId).update({ balance: firebase.firestore.FieldValue.increment(-amount) });
                alert('‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                closeModal('withdraw-modal');
                e.target.reset();
            } catch (error) { alert('‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§'); } finally { btn.disabled = false; }
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        async function updateLastSeen() { if (currentUserId) { db.collection('users').doc(currentUserId).update({ lastSeen: new Date() }).catch(() => {}); } }
        async function addActivity(title, amount, forUserId) { if (amount > 0) { db.collection('activities').add({ userId: forUserId, title, amount, timestamp: new Date().toISOString() }); } }
        function populateSupportModal() { const container = document.getElementById('support-links-container'); container.innerHTML = ''; (appSettings.supportLinks || []).forEach(link => { if(link.url) container.innerHTML += `<a href="${link.url}" target="_blank" class="glass-card p-4 text-center"><i class="${link.icon || 'fas fa-headset'} text-2xl mb-2"></i><p>${link.name || 'Support'}</p></a>`; }); }
        function generateWheelSections() { const wheel = document.getElementById('wheel'); if (!wheel) return; wheel.innerHTML = ''; const colors = ['#3498db', '#e67e22', '#2ecc71', '#9b59b6', '#f1c40f', '#e74c3c', '#1abc9c', '#34495e']; const angle = 360 / (appSettings.spinPrizes?.length || 8); (appSettings.spinPrizes || []).forEach((prize, index) => { const section = document.createElement('div'); section.className = 'wheel-section'; section.style.background = colors[index % colors.length]; section.style.transform = `rotate(${index * angle}deg)`; section.innerHTML = `<span>‡ß≥${prize}</span>`; wheel.appendChild(section); }); }
        async function loadAdScriptsAndSettings(collectionName) { /* ... This function can be copied from previous versions ... */ return {ads:[]}; }
        async function showMandatoryAdAfterAction(adQueue) { /* ... This function can be copied from previous versions ... */ return Promise.resolve(); }
    </script>
</body>
</html>
